<?php // -*-html-*- ?>
<!-- $Id: userprefs.tmpl,v 1.36 2003-12-01 22:23:01 carstenklapp Exp $ -->
<?php
// Todo: Move the logic and code to the plugin
// This is very experimental and the read-only part an ugly hack so far.
foreach (explode(',','errmsg,isForm') as $var) {
    if (empty($$var)) $$var = false;
}

$plugin = $request->getArg('pagename');
if ($request->isActionPage($request->getArg('pagename')) and 
    $plugin != _("PreferencesInfo")) {
    $isForm = true;
}

$time = time();
$user = &$request->getUser();
$_upo = $user->getPreferences();
$pref = $_upo->_prefs;

$offset = $pref['timeOffset'];
$serverTime = $time - $offset * 3600;
if ( $isForm )
    $timeOffsetInput = HTML::input(array('type' => "text",
                                         'size' => 6,
                                         'maxlength' => 6,
                                         'name' => "pref[timeOffset]",
                                         'class' => "numeric",
                                         'value' => $offset));
else
    $timeOffsetInput = $pref['timeOffset'];


$RelativeDatesCB = HTML(HTML::input(array('type' => 'hidden',
                                          'name' => 'pref[relativeDates][]',
                                          'value' => '0')),
                        HTML::input(array('type' => 'checkbox',
                                          'name' => 'pref[relativeDates][]',
                                          'value' => '1',
                                          'checked' => (bool) $pref['relativeDates'])));

$NoLinkIconsCB = HTML(HTML::input(array('type' => 'hidden',
                                          'name' => 'pref[noLinkIcons][]',
                                          'value' => '0')),
                        HTML::input(array('type' => 'checkbox',
                                          'name' => 'pref[noLinkIcons][]',
                                          'value' => '1',
                                          'checked' => (bool) $pref['noLinkIcons'])));

function selectedOption ($value, $label = false) {
    return HTML::option(array('value' => $value,'selected'=>"selected"), ($label ? $label : $value) . "\n");
}
function unselectedOption ($value, $label = false) {
    return HTML::option(array('value' => $value), ($label ? $label : $value) . "\n");
}

$SelectThemes = ''; $SelectLanguages = '';
$SelectThemesDesc = ''; $SelectLanguagesDesc = '';
if ( $isForm ) {
    $SelectOptions = HTML(); 
    if (!empty($available_themes) and is_array($available_themes)) {
	if (! $pref['theme'])
	    $SelectOptions->pushContent(selectedOption('',_("<system theme>")));
	else
	    $SelectOptions->pushContent(unselectedOption('',_("<system theme>")));
	foreach ($available_themes as $theme) {
	    if ($theme == $pref['theme'] and $theme != THEME)
		$SelectOptions->pushContent(selectedOption($theme));
	    else
		$SelectOptions->pushContent(unselectedOption($theme));
	}
	$SelectThemes = HTML::select(array('name' => "pref[theme]",'id' => 'theme'),
				     $SelectOptions);
	$SelectThemesDesc = _("Select your personal theme:");
    }
    
    $SelectOptions = HTML();
    if (!empty($available_languages) and is_array($available_languages)) {
	if (! $pref['lang'] )
	    $SelectOptions->pushContent(selectedOption('',_("<system language>")));
	else
	    $SelectOptions->pushContent(unselectedOption('',_("<system language>")));
	foreach ($available_languages as $lang) {
	    if ($lang == $pref['lang'] and $lang != DEFAULT_LANGUAGE)
		$SelectOptions->pushContent(selectedOption($lang));
	    else
		$SelectOptions->pushContent(unselectedOption($lang));
	}
	$SelectLanguages = HTML::select(array('name' => "pref[lang]",'id' => 'lang'),
					$SelectOptions);
	$SelectLanguagesDesc = _("Select your personal language:");
    } else {
	if ($SelectThemes == '') {
	    $appearance = false;
	    $SelectThemesDesc = '';
	    $SelectLanguagesDesc = '';
	}
    }
} else {
    $SelectThemesDesc = _("Personal theme:");
    $SelectLanguagesDesc = _("Personal language:");
    $SelectThemes = $pref['theme'];
    $SelectLanguages = $pref['lang'];
}

if ($errmsg) $msg = HTML(HTML::h4(array('class' => 'errors'), $errmsg),HTML::hr());
?>
<?= $errmsg ?>

<?php if ($isForm) { ?>
<form action="<?=$request->getPostURL()?>" method="post">
<?php } else { 
  $user = $request->_user; 
  $fill = "&nbsp;";
?>
<?= HTML::pre(sprintf("%12s: [% 10s]  %s\n",_("UserId"),$pref['userid'], " from " . $request->_user->auth_how()),
	      sprintf("%12s: [% 10s]  %16s: [% 10s] | %8s: [%2s]\n","getId",$user->getId(),"getAuthenticatedId",$user->getAuthenticatedId(),"isSignedIn", $user->isSignedIn()),
	      //sprintf("%12s: [% 10s]\n",_("Password"),$pref['passwd']),
	      sprintf("%12s: [% 10s]  %15s: [% 8s]\n",
		      _("Auth Level"),$user->_level,_("Auth Method"),$user->_authmethod),
	      sprintf("%12s: [% 10s]\n",_("HomePage"),$user->homePage() ? $user->_homepage->_pagename : ''),
	      sprintf("%12s: [% 10s]\n",_("E-Mail"),$pref['email']),
	      //sprintf("%12s: [% 10s]\n",_("Notify"),$pref['notifyPages']),
	      sprintf("%12s: [% 10s] %16s: [% 10s] \n",_("Theme"), $pref['theme'], _("Current Theme"),$Theme->_name),
	      sprintf("%12s: [% 10s] %16s: [% 10s] \n",_("Language"),$pref['lang'],_("Current Language"),$GLOBALS['LANG'])
	      ) ?>
<?php } ?>

<?php /* if ($isForm and !$user->isAdmin()) { ?>
  <h2><?=_("Change Password")?></h2>
     <input type="password" name="pref[passwd]" size="16" maxlength="16" class="text" value="" /> <?=_("New password")?>.<br />
     <input type="password" name="pref[passwd2]" size="16" maxlength="16" class="text" value="" /> <?=_("Type it again")?>.
<?php } */?>

  <h2><?=_("E-mail")?></h2>
  <p><?=_("Your E-Mail:")?>
  <?php if ($isForm) { ?>
     <input type="text" name="pref[email]" size="30" maxlength="60"
	    value="<?=$pref['email']?>" />
  <?php } else { ?>
     '<?= $pref['email'] ?>'
  <?php } ?>
  &nbsp;&nbsp;<?= _("Status:") ?>&nbsp;&nbsp;
  <?php if (!empty($pref['emailVerified']) && $pref['emailVerified']) { ?>
    <?= _("Email verified.") ?>
  <?php } else { ?>
    <?= _("Email not yet verified.") ?>
  <?php } ?>
  </p>
     <p class="hint">(<?=_("Note, that user accounts with bouncing emails will be disabled.")?>)</p>
     <?php /*
     Related code for this doesn't seem to function yet.
     Commented out for now until it can be finished or removed. --CarstenKlapp
   <p><?=_("Get an email notification at changes of the following pages:")?><br />
/* ?>
  <?php /*if ($isForm) { ?>
     &nbsp;<textarea name="pref[notifyPages]" cols="50" rows="5"><?=$pref['notifyPages']?></textarea>
     <p class="hint">(<?=_("Enter pages seperated by space or comma. Wildcards (fileglobbing) allowed.")?>)</p>
   </p>
  <?php } else { ?>
    <?=$pref['notifyPages']?>
  <?php } */ ?>
  <h2><?=_("Appearance")?></h2>
  <p class="hint"><?=_("Here you can override site-specific default values. Currently not recommended!")?></p>
  <?php /* Alternatively this could be done with <fieldset> and <legend>. */ ?>
  <p><?=$SelectThemesDesc?><br /> <?= $SelectThemes ?> <span class="hint"><?=_("System default:")?> <?= THEME ?></span></p>
  <p><?=$SelectLanguagesDesc?><br /> <?= $SelectLanguages ?> <span class="hint"><?=_("System default:")?> <?= DEFAULT_LANGUAGE ?></span></p>
  <p><?=$NoLinkIconsCB?> <?=fmt("Hide %s.", WikiLink("LinkIcons"))?></p>
  <p class="hint"><?=_("Hide or show LinkIcons (if supported by the current theme). Useful for text-only browsers or slow connections.")?></p>

  <h2><?=_("Edit Area Size")?></h2>
  <p><?=_("Height")?>
    <?php if ($isForm) { ?>
     <input type="text" name="pref[editHeight]" size="4" maxlength="4" class="numeric"
            value="<?=$pref['editHeight']?>" />
    <?php } else { ?>
      <?=$pref['editHeight']?>
    <?php } ?>
    <?=_("Width")?>
    <?php if ($isForm) { ?>
     <input type="text" name="pref[editWidth]" size="4" maxlength="4" class="numeric"
            value="<?=$pref['editWidth']?>" />
    <?php } else { ?>
      <?=$pref['editWidth']?>
    <?php } ?>
  </p>
  <p class="hint"><?=_("Note that many browsers will automatically adjust the width of the editing area so that it fills the browser window.  In this case, the width preference will be ignored.")?></p>

  <h2><?=_("Time Zone")?></h2>
  <p>
    <?=fmt("Add %s hours to the server's local time when reporting times.",
           $timeOffsetInput)?>
  </p>
  <p class="hint">
    <?=fmt("The current time at the server is %s.",
            HTML::strong($Theme->formatDateTime($serverTime)))?>
    <?=fmt("With the current offset, this would be reported as %s.",
           HTML::strong($Theme->formatDateTime($time)))?>
  </p>

  <h2><?=_("Date Format")?></h2>
  <p><?=$RelativeDatesCB?>
     <?=_("Show relative dates using 'Today' and 'Yesterday'.")?>
  </p>

<?php if ($isForm) { ?>
  <hr />
  <p><?=Button("submit:", _("Update Preferences"), 'wikiadmin')?><?=Button("submit:cancel", _("Cancel"), 'button')?></p>

<?= HiddenInputs($request->getArgs(), false, array('pref')) ?>
</form>
<?php } ?>
